<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTrace Contract Deployment - Testnet4</title>
    <script src="https://unpkg.com/@stacks/connect@7.8.0/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@stacks/transactions@6.13.0/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@stacks/network@6.13.0/dist/umd/index.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .contract-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9fafb;
        }
        .contract-card.deployed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .code-preview {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .wallet-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .deployment-log {
            background: #111827;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ AgriTrace Contract Deployment</h1>
            <h2>Stacks Testnet4 Deployment</h2>
            <p>Deploy your AgriTrace smart contracts using Leather Wallet</p>
        </div>

        <div class="wallet-info">
            <h3>üëõ Wallet Information</h3>
            <p><strong>Address:</strong> <span id="walletAddress">Not connected</span></p>
            <p><strong>Balance:</strong> <span id="walletBalance">-</span> STX</p>
            <p><strong>Network:</strong> Stacks Testnet4</p>
            <button id="connectWallet" class="btn">Connect Leather Wallet</button>
        </div>

        <div id="deploymentSection" style="display: none;">
            <h3>üì¶ Smart Contracts to Deploy</h3>
            <p>Deploy contracts in the following order to ensure proper dependencies:</p>

            <!-- Farmer Registry Contract -->
            <div class="contract-card" id="farmer-registry-card">
                <h4>1. üë®‚Äçüåæ Farmer Registry Contract</h4>
                <p><strong>Name:</strong> farmer-registry</p>
                <p><strong>Description:</strong> Manages farmer registration and verification system</p>
                <div class="status pending" id="farmer-registry-status">Ready to Deploy</div>
                <br>
                <button class="btn" id="deploy-farmer-registry" onclick="deployContract('farmer-registry')">
                    Deploy Farmer Registry
                </button>
                <button class="btn" onclick="toggleCode('farmer-registry')">View Contract Code</button>
                <div id="farmer-registry-code" class="code-preview" style="display: none;"></div>
                <div id="farmer-registry-result"></div>
            </div>

            <!-- Product Tracking Contract -->
            <div class="contract-card" id="product-tracking-card">
                <h4>2. üì¶ Product Tracking Contract</h4>
                <p><strong>Name:</strong> product-tracking</p>
                <p><strong>Description:</strong> Tracks product batches through supply chain stages</p>
                <div class="status pending" id="product-tracking-status">Waiting for Farmer Registry</div>
                <br>
                <button class="btn" id="deploy-product-tracking" onclick="deployContract('product-tracking')" disabled>
                    Deploy Product Tracking
                </button>
                <button class="btn" onclick="toggleCode('product-tracking')">View Contract Code</button>
                <div id="product-tracking-code" class="code-preview" style="display: none;"></div>
                <div id="product-tracking-result"></div>
            </div>

            <!-- Payment Escrow Contract -->
            <div class="contract-card" id="payment-escrow-card">
                <h4>3. üí∞ Payment Escrow Contract</h4>
                <p><strong>Name:</strong> payment-escrow</p>
                <p><strong>Description:</strong> Handles secure STX payments between buyers and farmers</p>
                <div class="status pending" id="payment-escrow-status">Waiting for Previous Contracts</div>
                <br>
                <button class="btn" id="deploy-payment-escrow" onclick="deployContract('payment-escrow')" disabled>
                    Deploy Payment Escrow
                </button>
                <button class="btn" onclick="toggleCode('payment-escrow')">View Contract Code</button>
                <div id="payment-escrow-code" class="code-preview" style="display: none;"></div>
                <div id="payment-escrow-result"></div>
            </div>
        </div>

        <div class="deployment-log">
            <h4>üìã Deployment Log</h4>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Contract codes (will be loaded)
        const contracts = {
            'farmer-registry': '',
            'product-tracking': '',
            'payment-escrow': ''
        };

        // Deployment state
        let deploymentState = {
            'farmer-registry': false,
            'product-tracking': false,
            'payment-escrow': false
        };

        // Network configuration
        const network = new StacksNetwork.StacksTestnet({ url: 'https://api.testnet.hiro.so' });
        
        let userSession = null;
        let userData = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function connectWallet() {
            try {
                log('üîå Connecting to Leather Wallet...');
                
                const authOptions = {
                    appDetails: {
                        name: 'AgriTrace Deployment',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzIyYzU1ZSIvPgo8cGF0aCBkPSJNMTIgMjBoMTZsLTggOHoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='
                    },
                    redirectTo: window.location.origin,
                    onFinish: (authData) => {
                        userData = authData.userSession.loadUserData();
                        updateWalletInfo();
                        document.getElementById('deploymentSection').style.display = 'block';
                        log('‚úÖ Wallet connected successfully!');
                    },
                    onCancel: () => {
                        log('‚ùå Wallet connection cancelled');
                    }
                };

                StacksConnect.showConnect(authOptions);
            } catch (error) {
                log(`‚ùå Error connecting wallet: ${error.message}`);
            }
        }

        async function updateWalletInfo() {
            if (!userData) return;

            const address = userData.profile.stxAddress.testnet;
            document.getElementById('walletAddress').textContent = address;

            try {
                const response = await fetch(`https://api.testnet.hiro.so/extended/v1/address/${address}/balances`);
                const data = await response.json();
                const stxBalance = parseInt(data.stx.balance) / 1000000;
                document.getElementById('walletBalance').textContent = stxBalance.toFixed(2);
                
                log(`üí∞ Wallet balance: ${stxBalance.toFixed(2)} STX`);
            } catch (error) {
                log(`‚ùå Error fetching balance: ${error.message}`);
            }
        }

        async function deployContract(contractName) {
            if (!userData) {
                log('‚ùå Please connect your wallet first');
                return;
            }

            try {
                log(`üöÄ Starting deployment of ${contractName}...`);
                
                // Update status
                document.getElementById(`${contractName}-status`).textContent = 'Deploying...';
                document.getElementById(`${contractName}-status`).className = 'status pending';
                document.getElementById(`deploy-${contractName}`).disabled = true;

                // Get contract code
                const contractCode = contracts[contractName];
                if (!contractCode) {
                    throw new Error(`Contract code not found for ${contractName}`);
                }

                // Create deployment transaction
                const txOptions = {
                    contractName: contractName,
                    codeBody: contractCode,
                    senderKey: userData.appPrivateKey,
                    network: network,
                    anchorMode: StacksTransactions.AnchorMode.Any,
                    postConditionMode: StacksTransactions.PostConditionMode.Allow,
                };

                log(`üìù Creating deployment transaction for ${contractName}...`);
                const transaction = await StacksTransactions.makeContractDeploy(txOptions);

                log(`üì° Broadcasting transaction...`);
                const broadcastResponse = await StacksTransactions.broadcastTransaction(transaction, network);

                if (broadcastResponse.error) {
                    throw new Error(broadcastResponse.error);
                }

                const txId = broadcastResponse.txid;
                log(`‚úÖ ${contractName} deployment submitted!`);
                log(`üîó Transaction ID: ${txId}`);
                log(`üåê Explorer: https://explorer.hiro.so/txid/${txId}?chain=testnet`);

                // Update UI
                document.getElementById(`${contractName}-status`).textContent = 'Deployed Successfully';
                document.getElementById(`${contractName}-status`).className = 'status success';
                document.getElementById(`${contractName}-card`).className = 'contract-card deployed';
                
                // Show result
                const resultDiv = document.getElementById(`${contractName}-result`);
                resultDiv.innerHTML = `
                    <p><strong>‚úÖ Deployment Successful!</strong></p>
                    <p><strong>Transaction ID:</strong> <a href="https://explorer.hiro.so/txid/${txId}?chain=testnet" target="_blank">${txId}</a></p>
                    <p><strong>Contract Address:</strong> ${userData.profile.stxAddress.testnet}.${contractName}</p>
                `;

                // Update deployment state
                deploymentState[contractName] = true;
                updateDeploymentButtons();

                log(`üéâ ${contractName} deployed successfully!`);

            } catch (error) {
                log(`‚ùå Error deploying ${contractName}: ${error.message}`);
                
                // Update status
                document.getElementById(`${contractName}-status`).textContent = 'Deployment Failed';
                document.getElementById(`${contractName}-status`).className = 'status error';
                document.getElementById(`deploy-${contractName}`).disabled = false;
            }
        }

        function updateDeploymentButtons() {
            // Enable product-tracking if farmer-registry is deployed
            if (deploymentState['farmer-registry']) {
                document.getElementById('deploy-product-tracking').disabled = false;
                document.getElementById('product-tracking-status').textContent = 'Ready to Deploy';
            }

            // Enable payment-escrow if both previous contracts are deployed
            if (deploymentState['farmer-registry'] && deploymentState['product-tracking']) {
                document.getElementById('deploy-payment-escrow').disabled = false;
                document.getElementById('payment-escrow-status').textContent = 'Ready to Deploy';
            }
        }

        function toggleCode(contractName) {
            const codeDiv = document.getElementById(`${contractName}-code`);
            if (codeDiv.style.display === 'none') {
                codeDiv.style.display = 'block';
                if (!codeDiv.innerHTML) {
                    codeDiv.innerHTML = `Loading ${contractName} contract code...`;
                    loadContractCode(contractName);
                }
            } else {
                codeDiv.style.display = 'none';
            }
        }

        async function loadContractCode(contractName) {
            try {
                // In a real deployment, you would load this from your server
                // For now, we'll show placeholder text
                const codeDiv = document.getElementById(`${contractName}-code`);
                codeDiv.innerHTML = `
                    <p>Contract: ${contractName}.clar</p>
                    <p>‚ö†Ô∏è Contract code should be loaded from your local files</p>
                    <p>üìÅ Location: contracts/${contractName}.clar</p>
                    <p>üîß Copy the contract code from your local file and paste it here for deployment</p>
                `;
            } catch (error) {
                log(`‚ùå Error loading contract code: ${error.message}`);
            }
        }

        // Initialize
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        
        log('üåæ AgriTrace Deployment Interface Ready');
        log('üëõ Please connect your Leather Wallet to begin deployment');
        
        // Load contract codes (placeholder - in real deployment, load from files)
        log('üìÑ Contract codes ready for deployment');
    </script>
</body>
</html>